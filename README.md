# Neuro-Preprocessing Pipeline

## Project Goal

This repository contains the MATLAB source code for a preprocessing pipeline designed to convert raw electrophysiology data (from Ripple/PLDAPS systems and Kilosort) into a standardized, analysis-ready format (`session_data.mat`).

## Workflow Overview

The pipeline is driven by a central manifest file and operates in a three-stage process that includes a manual spike-sorting step.

### 1. Preparation (Stage 1a - Automated)
This stage is triggered by running the master script (`run_preprocessing.m`) on manifest entries with a `raw` status. For each entry, it performs the following:
* **Reads Raw Neural Data:** Loads the continuous broadband data from the specified `.ns5` file.
* **Channel Slicing:** Selects only the channels specified in the manifest's `channel_numbers` column for the current job.
* **Creates Binary File:** Writes the selected channel data to a binary `.dat` file in `int16` format, which is required for Kilosort.
* **Parses NEV Events:** Reads the corresponding `.nev` file, which contains a stream of strobed digital words sent from the PLDAPS experiment PC. Using a set of predefined event code definitions (from `initCodeCats.m` and `getEventTimes.m`), this raw stream is parsed into two key structures:
    * `trialInfo`: A trial-by-trial structure containing metadata for each trial (e.g., task codes, trial counts).
    * `eventTimes`: A structure containing the precise timestamps of key behavioral events within each trial (e.g., `targetOn`, `saccadeOn`).
* **Integrates Behavioral Data:** Searches for and loads the PLDAPS behavioral `.mat` files corresponding to the session. It then injects continuous data streams (like eye X/Y position, pupil size, and joystick voltage) and other trial-specific variables into the intermediate data structure.
* **Updates Status:** Saves an intermediate `.mat` file containing the integrated event/behavioral data and updates the manifest status to `prepared`.

### 2. Spike Sorting (Manual)
The user manually runs Kilosort/Phy on the `.dat` file generated in the Preparation stage. Once sorting and manual curation are complete, the user updates the job's status in the manifest to `sorted`.

### 3. Consolidation (Stage 1b - Automated)
The user re-runs the master script. It now identifies `sorted` jobs and performs the final consolidation:
* **Loads Kilosort Output:** Reads the spike times, cluster assignments, and other metrics from the `.npy` files generated by Kilosort.
* **Merges Data:** Combines the Kilosort spike data with the intermediate event/behavioral data from Stage 1a.
* **Saves Final Output:** Saves the complete, merged dataset as the final `session_data.mat` file in the designated output directory.
* **Updates Status:** Updates the manifest status to `complete`.

---

## The `sessions_manifest.csv` File

This pipeline is controlled by the `config/sessions_manifest.csv` file. Each row represents a single, atomic unit of work (typically the data from one probe in a recording session).

### Manifest Columns

| Column Name | Description |
| :--- | :--- |
| `unique_id` | The unique primary key for this job (e.g., `MonkeyA_20250822_SC`). |
| `session_group_id`| An ID to link all probes recorded simultaneously. |
| `monkey` | The name of the subject. |
| `date` | The date of the recording (YYYY-MM-DD). |
| `experiment_pc_name`| The name of the behavioral control PC (`pldaps1` or `pldaps2`). |
| `probe_type` | The type of probe used (e.g., `Plexon V-Probe`). |
| `brain_area` | The brain area targeted by this probe (e.g., `SC`). |
| `channel_numbers`| A MATLAB-readable string defining the channels for this probe (e.g., `'1:32'`). |
| `channel_ordering`| A string defining the probe's physical channel order. |
| `raw_filename_base`| The base name of the raw data files (e.g., `monkeya_08222025_01`). |
| `status` | The processing state: `raw`, `prepared`, `sorted`, `complete`, or `error`. |
| `notes` | Free-text field for comments. |

---

## Usage

1.  **Add a Job:** Add one or more new rows to `config/sessions_manifest.csv`, setting the `status` to `raw`.
2.  **Run the Pipeline:** Execute the master script from the MATLAB command line: `>> run_preprocessing`
3.  **Perform Manual Sorting:** Run Kilosort on the generated `.dat` file and update the manifest `status` to `sorted`.
4.  **Re-run the Pipeline:** Execute `run_preprocessing` again to complete the consolidation.